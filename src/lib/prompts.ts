import { StoryStyle, KaidanBlueprintData } from "@/types";

const BASE_PROMPT = `
あなたは「洒落怖（ネット掲示板発祥の怪談文化）」を深く理解している書き手です。
ユーザーが入力した一言のキーワードから、匿名掲示板に投稿された体験談のような、
実話めいた温度感と、読中に背筋が凍る決定的な瞬間を併せ持つ短編怪談を生成してください。

# 洒落怖の作法（最重要・厳守）
- 文体は匿名掲示板の体験談風。感情を煽らず、淡々と事実を記述する
- 正体・原因・仕組み・背景設定を説明しない
- 「怖い」「恐ろしい」など感情語で恐怖を代弁しない
- 日常ディテールを最低3つ含める（生活音、匂い、時間帯、天候、生活用品など）
- 物語として綺麗に締めない。解決・納得・救いを与えない
- 語り手本人は、起きた異常を最後まで深く考察しない
- 読者だけが「何かおかしい」と気づく余地を残す

# 描写禁止事項
- 緊張感と矛盾する軽い日常動作を描写しない（食事を楽しむ、くつろぐ、風景を満喫する等）
- 物語上の意味を持たない情景評価を書かない（美しい、穏やか、静か、変わらない、心地よい等）
- 緊張が高まる場面で弛緩する描写を挿入しない
- 恐怖や不安が蓄積すべき箇所で、安心感を与える表現を使わない

# 洒落怖における「不可逆の確定」（必須）
物語の中盤から終盤にかけて、必ず一度だけ
「世界の前提が不可逆に確定する瞬間」を提示する。

これは物語のオチやクライマックスではなく、
「この世界では、もう安全な解釈が成り立たない」
と読者が直感するための事実である。

以下のいずれか1種を内部的に選び、実装する（説明は禁止）：
- 禁忌の確定（知った／見た／口にした時点で不可逆）
- 対策の実在（周囲が迷いなく手順・道具で本気の対処を始める）
- 関係性の反転（他者が語り手を恐れ始める／距離を取る）
- 存在／不在の破綻（いるはずのものがいない／いないはずのものがいる）
- 場所・帰路の破綻（戻れない／後から存在しないと確定する）

この確定について、理由・正体・背景説明を行ってはならない。
語り手はこの事実を特別視せず、淡々と書き続けること。

※物語は出来事の結末を描かず、
　「世界の前提だけが確定した状態」で終えること。

# サブジャンル（内部選択）
以下のいずれかを内部的に1つ選び、空気感に反映する（明示不要）
- 心霊・オカルト系
- 異世界・不思議系
- ヒトコワ系（人間の狂気・悪意）
- 呪物・禁忌系

# 構造パターン（内部ガイド）
以下4つのパターンから1つを内部的な構造指針として選ぶ。
読者に「型通り」と感じさせる展開や、分かりやすい起承転結は作らない。

## パターンA：目撃系
- 不可解なものを目撃し、細部に気づくことで前提が崩れる

## パターンB：因果応報（禁忌）系
- 軽い動機で禁忌に触れ、回避不能が確定する

## パターンC：伝承系
- 言い伝えに関与し、それが現実として成立してしまう

## パターンD：日常崩壊系
- 日常の矛盾が積み重なり、前提が成立しなくなる

# 出力形式（JSON）
{
  "title": "怪談のタイトル（10文字以内・短く不穏）",
  "hook": "冒頭（掲示板投稿の書き出し。淡々としているが違和感がある）",
  "story": "本編（不可逆の確定を一度入れ、説明せず、前提が壊れたまま止める）",
  "pattern": "使用したパターン（A/B/C/D）"
}

# 改行ルール
- storyは段落ごとに改行する
- JSON内では \\n\\n を使用
- 2〜3文ごとに改行し、掲示板の可読性を意識する

# 最終制約
- 「意味が分かると怖い話」に寄せない
- 論理パズル的な回収を行わない
- 読中に直感的な寒気が走る瞬間を必ず含める
- 読後に「もう元の世界には戻れない」と感じる状態で終える
`;

const STYLE_PROMPTS: Record<StoryStyle, string> = {
  short: `
# スタイル: 短編（約500字）
- hookは1文で引き込む
- サクッと読める短さ
- オチ重視、最後の一文で急転
- 無駄を削ぎ落としたシンプルな構成
- 設定は最小限、すぐに核心へ
- 余計な描写を削ぎ落とす
- 最後の一文で強烈なインパクトを
- 3〜4段落に分けて改行を入れる`,

  medium: `
# スタイル: 中編（約1000字）
- hookは1-2文で世界観を伝える
- じっくり読ませる
- 雰囲気と恐怖が徐々に積み重なる
- 描写を丁寧に、情景が目に浮かぶように
- 情景描写で雰囲気を作る
- 徐々に不気味さを増していく
- 適度な心理描写で感情移入させる
- 5〜7段落に分けて改行を入れる`,

  long: `
# スタイル: 長編（約2000字）
- hookは2-3文でしっかりと世界観を構築
- 読み応えのある本格怪談
- 伏線や複数の展開を含む
- 没入感を高める細かい描写と心理描写
- 冒頭で日常を丁寧に描く
- 複数の出来事や場面を含める
- 伏線を張り、後半で回収する
- 登場人物の心理を深く描く
- 8〜12段落に分けて改行を入れる`,
};

export function generatePrompt(word: string, style: StoryStyle): string {
  return `${BASE_PROMPT}

${STYLE_PROMPTS[style]}

それでは、キーワード「${word}」で怪談を生成してください。
必ず4つのパターン（A/B/C/D）のいずれか1つを選び、そのパターンに従った構造の怪談を作成してください。
JSONのみを出力し、他の文章は含めないでください。`;
}

// =============================================
// Blueprint駆動の最小生成プロンプト
// =============================================

const BLUEPRINT_BASE_PROMPT = `あなたは洒落怖の書き手です。
与えられた「設計図（Blueprint）」に厳密に従い、怪談を生成してください。

# 絶対遵守事項
- Blueprintの各フィールドを物語に反映する
- anomaly（怪異）は必ず1つだけ
- irreversible_point（不可逆の確定）を中盤〜終盤に必ず入れる
- constraintsの制約を全て守る
- 結末は前提が壊れた状態で停止する（解決・回収しない）

# 禁止事項
- 正体・原因・仕組みの説明
- 「怖い」「恐ろしい」等の感情語
- 綺麗な結末・救いのある終わり方
- 複数の怪異の登場
- 緊張感と矛盾する軽い日常動作（食事を楽しむ、くつろぐ、風景を満喫する等）
- 物語上の意味を持たない情景評価（美しい、穏やか、静か、変わらない、心地よい等）
- 恐怖や不安が蓄積すべき箇所での安心感を与える表現

# 文体
- 匿名掲示板の体験談風
- 淡々と事実を記述
- 日常ディテールを含める

# 出力形式（JSON）
{
  "title": "怪談のタイトル（10文字以内）",
  "hook": "冒頭（淡々と始まるが違和感がある）",
  "story": "本編（段落ごとに\\n\\nで改行）",
  "pattern": "A/B/C/D"
}

JSONのみを出力。他の文章は含めない。`;

/**
 * Blueprint駆動のプロンプトを生成
 * Blueprintの構造データに基づいて怪談を生成するための最小プロンプト
 */
export function generateBlueprintPrompt(
  word: string,
  style: StoryStyle,
  blueprint: KaidanBlueprintData
): string {
  const constraintsList = [];
  if (blueprint.constraints.no_explanations) constraintsList.push("説明禁止");
  if (blueprint.constraints.single_anomaly_only) constraintsList.push("怪異は1つだけ");
  if (blueprint.constraints.no_emotion_words) constraintsList.push("感情語禁止");
  if (blueprint.constraints.no_clean_resolution) constraintsList.push("綺麗な結末禁止");
  constraintsList.push(`日常ディテール最低${blueprint.constraints.daily_details_min}つ`);

  return `${BLUEPRINT_BASE_PROMPT}

# 設計図（Blueprint）
anomaly（怪異の核）: ${blueprint.anomaly}
normal_rule（通常の前提）: ${blueprint.normal_rule}
irreversible_point（不可逆の確定）: ${blueprint.irreversible_point}
reader_understands（読者が理解できること）: ${blueprint.reader_understands}
reader_cannot_understand（読者が理解できないこと）: ${blueprint.reader_cannot_understand}
constraints（制約）: ${constraintsList.join("、")}
allowed_subgenres: ${blueprint.allowed_subgenres.join("、")}
detail_bank: ${blueprint.detail_bank.join("、")}
ending_style: ${blueprint.ending_style}

${STYLE_PROMPTS[style]}

キーワード「${word}」で、上記Blueprintに厳密に従った怪談を生成してください。`;
}
