import { StoryStyle, KaidanBlueprintData, EndingMode } from "@/types";

const BASE_PROMPT = `
あなたは「洒落怖（ネット掲示板発祥の怪談文化）」を深く理解している書き手です。
ユーザーが入力した一言のキーワードから、匿名掲示板に投稿された体験談のような、
実話めいた温度感と、読中に背筋が凍る決定的な瞬間を併せ持つ短編怪談を生成してください。

# 洒落怖の作法（最重要・厳守）
- 文体は匿名掲示板の体験談風。感情を煽らず、淡々と事実を記述する
- 正体・原因・仕組み・背景設定を説明しない
- 「怖い」「恐ろしい」など感情語で恐怖を代弁しない
- 日常ディテールを最低3つ含める（生活音、匂い、時間帯、天候、生活用品など）
- 物語として綺麗に締めない。解決・納得・救いを与えない
- 語り手本人は、起きた異常を最後まで深く考察しない
- 読者だけが「何かおかしい」と気づく余地を残す

# 描写禁止事項
- 緊張感と矛盾する軽い日常動作を描写しない（食事を楽しむ、くつろぐ、風景を満喫する等）
- 物語上の意味を持たない情景評価を書かない（美しい、穏やか、静か、変わらない、心地よい等）
- 緊張が高まる場面で弛緩する描写を挿入しない
- 恐怖や不安が蓄積すべき箇所で、安心感を与える表現を使わない

# 洒落怖における「不可逆の確定」（必須）
物語の中盤から終盤にかけて、必ず一度だけ
「世界の前提が不可逆に確定する瞬間」を提示する。

これは物語のオチやクライマックスではなく、
「この世界では、もう安全な解釈が成り立たない」
と読者が直感するための事実である。

以下のいずれか1種を内部的に選び、実装する（説明は禁止）：
- 禁忌の確定（知った／見た／口にした時点で不可逆）
- 対策の実在（周囲が迷いなく手順・道具で本気の対処を始める）
- 関係性の反転（他者が語り手を恐れ始める／距離を取る）
- 存在／不在の破綻（いるはずのものがいない／いないはずのものがいる）
- 場所・帰路の破綻（戻れない／後から存在しないと確定する）

この確定について、理由・正体・背景説明を行ってはならない。
語り手はこの事実を特別視せず、淡々と書き続けること。

※物語は出来事の結末を描かず、
　「世界の前提だけが確定した状態」で終えること。

# サブジャンル（内部選択）
以下のいずれかを内部的に1つ選び、空気感に反映する（明示不要）
- 心霊・オカルト系
- 異世界・不思議系
- ヒトコワ系（人間の狂気・悪意）
- 呪物・禁忌系

# 構造パターン（内部ガイド）
以下4つのパターンから1つを内部的な構造指針として選ぶ。
読者に「型通り」と感じさせる展開や、分かりやすい起承転結は作らない。

## パターンA：目撃系
- 不可解なものを目撃し、細部に気づくことで前提が崩れる

## パターンB：因果応報（禁忌）系
- 軽い動機で禁忌に触れ、回避不能が確定する

## パターンC：伝承系
- 言い伝えに関与し、それが現実として成立してしまう

## パターンD：日常崩壊系
- 日常の矛盾が積み重なり、前提が成立しなくなる

# 出力形式（JSON）
{
  "title": "怪談のタイトル（10文字以内・短く不穏）",
  "hook": "冒頭（掲示板投稿の書き出し。淡々としているが違和感がある）",
  "story": "本編（不可逆の確定を一度入れ、説明せず、前提が壊れたまま止める）",
  "pattern": "使用したパターン（A/B/C/D）"
}

# 改行ルール
- storyは段落ごとに改行する
- JSON内では \\n\\n を使用
- 2〜3文ごとに改行し、掲示板の可読性を意識する

# 最終制約
- 「意味が分かると怖い話」に寄せない
- 論理パズル的な回収を行わない
- 読中に直感的な寒気が走る瞬間を必ず含める
- 読後に「もう元の世界には戻れない」と感じる状態で終える
`;

const STYLE_PROMPTS: Record<StoryStyle, string> = {
  short: `
# スタイル: 短編（約500字）
- hookは1文で引き込む
- サクッと読める短さ
- オチ重視、最後の一文で急転
- 無駄を削ぎ落としたシンプルな構成
- 設定は最小限、すぐに核心へ
- 余計な描写を削ぎ落とす
- 最後の一文で強烈なインパクトを
- 3〜4段落に分けて改行を入れる`,

  medium: `
# スタイル: 中編（約1000字）
- hookは1-2文で世界観を伝える
- じっくり読ませる
- 雰囲気と恐怖が徐々に積み重なる
- 描写を丁寧に、情景が目に浮かぶように
- 情景描写で雰囲気を作る
- 徐々に不気味さを増していく
- 適度な心理描写で感情移入させる
- 5〜7段落に分けて改行を入れる`,

  long: `
# スタイル: 長編（約2000字）
- hookは2-3文でしっかりと世界観を構築
- 読み応えのある本格怪談
- 伏線や複数の展開を含む
- 没入感を高める細かい描写と心理描写
- 冒頭で日常を丁寧に描く
- 複数の出来事や場面を含める
- 伏線を張り、後半で回収する
- 登場人物の心理を深く描く
- 8〜12段落に分けて改行を入れる`,
};

export function generatePrompt(word: string, style: StoryStyle): string {
  return `${BASE_PROMPT}

${STYLE_PROMPTS[style]}

それでは、キーワード「${word}」で怪談を生成してください。
必ず4つのパターン（A/B/C/D）のいずれか1つを選び、そのパターンに従った構造の怪談を作成してください。
JSONのみを出力し、他の文章は含めないでください。`;
}

// =============================================
// Blueprint駆動の最小生成プロンプト
// =============================================

const BLUEPRINT_BASE_PROMPT = `あなたは洒落怖の書き手です。
与えられた「設計図（Blueprint）」に厳密に従い、怪談を生成してください。

# 絶対遵守事項
- Blueprintの各フィールドを物語に反映する
- anomaly（怪異）は必ず1つだけ
- irreversible_point（不可逆の確定）を中盤〜終盤に必ず入れる
- constraintsの制約を全て守る
- 結末は前提が壊れた状態で停止する（解決・回収しない）

# 禁止事項
- 正体・原因・仕組みの説明
- 「怖い」「恐ろしい」等の感情語
- 綺麗な結末・救いのある終わり方
- 複数の怪異の登場
- 緊張感と矛盾する軽い日常動作（食事を楽しむ、くつろぐ、風景を満喫する等）
- 物語上の意味を持たない情景評価（美しい、穏やか、静か、変わらない、心地よい等）
- 恐怖や不安が蓄積すべき箇所での安心感を与える表現

# 文体
- 匿名掲示板の体験談風
- 淡々と事実を記述
- 日常ディテールを含める

# 出力形式（JSON）
{
  "title": "怪談のタイトル（10文字以内）",
  "hook": "冒頭（淡々と始まるが違和感がある）",
  "story": "本編（段落ごとに\\n\\nで改行）",
  "pattern": "A/B/C/D"
}

JSONのみを出力。他の文章は含めない。`;

/**
 * Blueprint駆動のプロンプトを生成
 * Blueprintの構造データに基づいて怪談を生成するための最小プロンプト
 */
export function generateBlueprintPrompt(
  word: string,
  style: StoryStyle,
  blueprint: KaidanBlueprintData
): string {
  const constraintsList = [];
  if (blueprint.constraints.no_explanations) constraintsList.push("説明禁止");
  if (blueprint.constraints.single_anomaly_only) constraintsList.push("怪異は1つだけ");
  if (blueprint.constraints.no_emotion_words) constraintsList.push("感情語禁止");
  if (blueprint.constraints.no_clean_resolution) constraintsList.push("綺麗な結末禁止");
  constraintsList.push(`日常ディテール最低${blueprint.constraints.daily_details_min}つ`);

  return `${BLUEPRINT_BASE_PROMPT}

# 設計図（Blueprint）
anomaly（怪異の核）: ${blueprint.anomaly}
normal_rule（通常の前提）: ${blueprint.normal_rule}
irreversible_point（不可逆の確定）: ${blueprint.irreversible_point}
reader_understands（読者が理解できること）: ${blueprint.reader_understands}
reader_cannot_understand（読者が理解できないこと）: ${blueprint.reader_cannot_understand}
constraints（制約）: ${constraintsList.join("、")}
allowed_subgenres: ${blueprint.allowed_subgenres.join("、")}
detail_bank: ${blueprint.detail_bank.join("、")}
ending_style: ${blueprint.ending_style}

${STYLE_PROMPTS[style]}

キーワード「${word}」で、上記Blueprintに厳密に従った怪談を生成してください。`;
}

// =============================================
// 3フェーズ生成用プロンプトテンプレート
// =============================================

/**
 * Phase A: opening（前提）
 *
 * 【最終定義】
 * - 最大1文のみ
 * - 内容は「時間・場所・立場」の事実のみ
 * - 禁止：感想、予告、未来視点、不穏さの示唆、心情描写
 * - Phase A は「舞台を置く」だけで終える
 */
export const PHASE_A_TEMPLATE = `あなたは洒落怖調の怪談を書いています。
物語の舞台を「1文だけ」で設定してください。

【絶対ルール】
- 出力は必ず1文のみ（句点「。」で終わる1文）
- 内容は「時間・場所・立場」の事実だけ
- 2文以上は禁止

【禁止事項（厳守）】
- 感想（不思議な、奇妙な、違和感、気になる 等）
- 予告（まさか〜とは、後に〜、この時はまだ〜 等）
- 未来視点（〜とは思わなかった、〜とは知らなかった 等）
- 不穏さの示唆（何かが、妙に、いつもと違う 等）
- 心情描写（嫌な予感、落ち着かない、気が重い 等）
- 形容詞による雰囲気付け（静かな、薄暗い、不気味な 等）

【OK例】
「真昼の県道を車で走っていた。」
「新しく引っ越したアパートで一人暮らしを始めた。」
「大学2年の夏、実家に帰省していた。」
「仕事帰り、いつもの道を歩いていた。」

【NG例】
「まさかあんなことになるとは思わなかった。」
「この時はまだ何も知らなかった。」
「後に恐ろしいことが起きる場所だった。」
「なんとなく気になる道だった。」
「どこか違和感のあるアパートだった。」

normal_rule:
{normal_rule}`;

/**
 * Phase B: disturbance（違和感）
 *
 * 【最終定義】
 * - Phase A の直後の出来事から書き始める
 * - Phase A の内容（場所・状況・前提）を再説明することを完全禁止
 * - Phase B の1文目は必ず「変化・違和感・行動」のいずれかにする
 *
 * 使用可：anomaly（正体や原因は絶対に説明しない）
 * 禁止：説明、原因、設定解説、怪異の増殖
 */
export const PHASE_B_TEMPLATE = `あなたは洒落怖調の怪談を書いています。
Phase A（前段）の「続き」として、違和感・怪異の兆候を描写してください。

【最重要】Phase A / B 境界ルール（厳守）：
Phase B は Phase A の「続き」であり、Phase A の「再提示」ではない。

1. Phase A の内容を一切書き直さない
   - Phase A で示した場所・状況・前提を再説明しない
   - Phase A と同じ情報を別の言葉で言い換えない
   - 「そのアパートは〜」「この道は〜」のような再言及は禁止

2. Phase B の1文目は「変化・違和感・行動」のいずれかで始める
   OK開始例：
   - 「ふと、」
   - 「走り続けているうちに、」
   - 「その途中で、」
   - 「しばらくしてから、」
   - 「何気なく窓の外を見ると、」
   - 「数分後、」

   NG開始例：
   - 「真昼の県道を〜」（Phase A の再掲）
   - 「新しく引っ越したアパートは〜」（Phase A の再掲）
   - 「そのアパートは〜」（Phase A の言い換え）
   - 「俺が勤める会社は〜」（導入の再掲）
   - 「私たちは〜向かった」（Phase A の繰り返し）

3. 禁止する冒頭パターン
   - 主語＋状態動詞（あった／住んでいた／走っていた 等）
   - Phase A と同じ文型
   - 場所・設定の説明文

【出来事再描写禁止】：
- Phase A で起きた出来事そのものを、Phase B で再度書くことは禁止
- Phase B は Phase A の「後」に起きた *別の出来事* のみを書く
  NG例：A「電話が鳴った」→ B「電話が鳴った。母が出た」
  OK例：A「電話が鳴った」→ B「母が受話器を置いた後、しばらく黙っていた」

【行動整合性ルール】：
- 同時に成立しない行動を描写しない（例：運転しながら双眼鏡を覗く）
- 危険行動は必ず段階を踏む（例：停車 → 観察 → 異変 → 行動）
- 逃走・放棄は、直前に差し迫った危険が描写された後のみ許可
- 行動は「なぜそうせざるを得なかったか」が直前の描写から自然に理解できるように

制約：
- 怪異は1種類のみ
- 情景評価語は禁止
- 説明・考察は禁止
- 違和感に直行する（前置き不要）

キーワード主役化ルール（必須）：
- 前段で登場したキーワードを怪異の核、または怪異のトリガーとして扱う
- 「キーワードが登場する＝怪異が近づく/反応する」という関係を作る
- キーワードの出現は最大2回まで（連呼は絶対に避ける）

擬音ルール（許可）：
- 擬音は使用可（例：ギシ、ドン、ガン、カタン、ぺたぺた 等）
- 1シーンにつき最大2回まで
- 擬音だけの連続は禁止
- 擬音は状況描写の補助であり、雰囲気説明の代替にしない

セリフのルール：
- 人間のセリフは最大2行まで。短く、説明的でないこと
- 怪異の反応（喋る/笑う/呼ぶ/囁く）は短いセリフで表現してよい（最大1-2行）
- 怪異の説明・理由・自己紹介は禁止（例：「私は◯◯だ」はNG）
- セリフ内の「！」は使用可
- セリフ内の「...」は使用可（ただし文として完結させること。例：OK「……来た。」/ NG「……来」）
- 言いかけのセリフ（文末が省略記号/ダッシュのみで終わる）は禁止
- 世界観の説明・原因の解説をセリフでしない

怪異のセリフ品質ルール（重要）：
- 定番ホラーセリフ禁止：「やっと出られる」「一緒に遊ぼう」「待ってたよ」「見つけた」「おいで」など陳腐な表現は使わない
- 意図が明確すぎるセリフ禁止：怪異の目的や感情が分かりやすいセリフは避ける
- 怪異のセリフは以下のいずれかであるべき：
  - 文脈から浮いている（なぜそれを言うのか分からない）
  - 日常的すぎて逆に不気味（普通の挨拶、業務連絡のような）
  - 意味は分かるが、なぜ今それを言うのか理解できない
  - 独り言のようで、語り手に向けていない
- 良い例：「火曜日だね」「三番目」「お母さんに怒られる」「また間違えた」
- 悪い例：「逃げられないよ」「ずっと見てたよ」「やっと会えた」「連れていく」

anomaly:
{anomaly}`;

/**
 * Phase C: irreversible_point + climax（前提崩壊＋クライマックス）
 * 使用可：irreversible_point
 * 禁止：解決、回収、後日談、説明
 *
 * ending_mode対応:
 * - "open": 不可逆点で止める（解決・説明禁止）
 * - "partial_explanation": 原因・正体・事実を「1点だけ」明かして止める
 *
 * 構造（C1 + C2）:
 * C1: 不可逆点（閉じ込め/確定）
 * C2: 短いクライマックス（パニック→現象の顕在化→脱出or生存確認）
 * 最後: 余韻の一文で締める
 */
export const PHASE_C_TEMPLATE_OPEN = `あなたは洒落怖調の怪談を書いています。
前提が完全に壊れた瞬間を描写し、短いクライマックスを経て終わらせてください。

必須構造（この順序で書くこと）：
1. 不可逆点の事実描写（C1）
   - 「もう安全な解釈が成り立たない」と読者が直感する瞬間
   - 逃げ道がなくなる確定

2. 短いクライマックス（C2）数段落以内
   - 登場人物の反応（パニック/混乱/決断）
   - 怪異の"顕在化"（1シーンだけ：見える/聞こえる/触れる等）
   - 脱出または生存確認（ただし何だったかは不明のまま）

3. 余韻を固定する短文1つで締める
   - 状況・配置・状態の固定（観測的な終わり方）
   - 説明は禁止

例（余韻の短文）：
「あの部屋の電気は、今も点いているらしい。」
「窓の外には、まだ誰かがいた。」
「それ以来、あの道は通っていない。」

制約：
- 解決・回収・説明は禁止（何だったかは分からないまま）
- 完全な後日談は禁止（生存確認程度はOK）
- 理由付けをしない

【行動整合性ルール】：
- 同時に成立しない行動を描写しない（例：運転しながら双眼鏡を覗く）
- 危険行動は必ず段階を踏む（停車 → 観察 → 異変 → 行動）
- 逃走・放棄は、直前に差し迫った怪異行動・危険が描写された後のみ許可
- 車・家・仕事など重要なものの放棄は、クライマックス到達後のみ許可
- 行動は「なぜそうせざるを得なかったか」が直前の描写から自然に理解できるように

キーワード主役化ルール（必須）：
- 前段のキーワードを怪異の核として最終的な恐怖に結びつける
- 「キーワードが登場する＝怪異が決定的になる」という関係を維持
- キーワードの出現は最大1回まで（前段で既に登場しているため連呼しない）

擬音ルール（許可）：
- 擬音は使用可（例：ギシ、ドン、ガン、カタン、ぺたぺた 等）
- クライマックスで最大2回まで
- 擬音だけの連続は禁止

セリフのルール：
- 人間のセリフは最大2行まで
- 怪異の反応（喋る/笑う/呼ぶ/囁く）は短いセリフで表現してよい（最大1-2行）
- 怪異の説明・理由・自己紹介は禁止
- セリフ内の「！」は使用可
- セリフ内の「...」は使用可（ただし文として完結させること）
- 言いかけのセリフ（文末が省略記号/ダッシュのみで終わる）は禁止
- 世界観の説明・原因の解説をセリフでしない

怪異のセリフ品質ルール（重要）：
- 定番ホラーセリフ禁止：「やっと出られる」「一緒に遊ぼう」「待ってたよ」「見つけた」「おいで」など陳腐な表現は使わない
- 意図が明確すぎるセリフ禁止：怪異の目的や感情が分かりやすいセリフは避ける
- 怪異のセリフは以下のいずれかであるべき：
  - 文脈から浮いている（なぜそれを言うのか分からない）
  - 日常的すぎて逆に不気味（普通の挨拶、業務連絡のような）
  - 独り言のようで、語り手に向けていない
- 良い例：「火曜日だね」「三番目」「お母さんに怒られる」
- 悪い例：「逃げられないよ」「ずっと見てたよ」「連れていく」

irreversible_point:
{irreversible_point}`;

export const PHASE_C_TEMPLATE_PARTIAL = `あなたは洒落怖調の怪談を書いています。
前提が完全に壊れた瞬間を描写し、短いクライマックスを経て終わらせてください。
ただし、原因・正体・事実のうち「1点だけ」を明かしてよい。

必須構造（この順序で書くこと）：
1. 不可逆点の事実描写（C1）
   - 「もう安全な解釈が成り立たない」と読者が直感する瞬間

2. 短いクライマックス（C2）数段落以内
   - 登場人物の反応（パニック/混乱/決断）
   - 怪異の"顕在化"（1シーンだけ）
   - 脱出または生存確認
   - この中で「1点だけ」原因・正体・事実を明かしてよい
   ※ 分かったこと自体が不幸になる形で終わらせる

3. 余韻を固定する短文1つで締める
   - 状況・配置・状態の固定
   - 全体説明は禁止

制約：
- 解決は禁止（問題は解決しない）
- 全体説明は禁止（1点だけ明かす）
- 世界観まとめは禁止

【行動整合性ルール】：
- 同時に成立しない行動を描写しない（例：運転しながら双眼鏡を覗く）
- 危険行動は必ず段階を踏む（停車 → 観察 → 異変 → 行動）
- 逃走・放棄は、直前に差し迫った怪異行動・危険が描写された後のみ許可
- 車・家・仕事など重要なものの放棄は、クライマックス到達後のみ許可
- 行動は「なぜそうせざるを得なかったか」が直前の描写から自然に理解できるように

キーワード主役化ルール（必須）：
- 前段のキーワードを怪異の核として最終的な恐怖に結びつける
- 「キーワードが登場する＝怪異が決定的になる」という関係を維持
- キーワードの出現は最大1回まで（前段で既に登場しているため連呼しない）

擬音ルール（許可）：
- 擬音は使用可（例：ギシ、ドン、ガン、カタン、ぺたぺた 等）
- クライマックスで最大2回まで
- 擬音だけの連続は禁止

セリフのルール：
- 人間のセリフは最大2行まで
- 怪異の反応（喋る/笑う/呼ぶ/囁く）は短いセリフで表現してよい（最大1-2行）
- 怪異の説明・理由・自己紹介は禁止
- セリフ内の「！」は使用可
- セリフ内の「...」は使用可（ただし文として完結させること）
- 言いかけのセリフ（文末が省略記号/ダッシュのみで終わる）は禁止
- ルールの講義をセリフでしない

怪異のセリフ品質ルール（重要）：
- 定番ホラーセリフ禁止：「やっと出られる」「一緒に遊ぼう」「待ってたよ」「見つけた」「おいで」「連れていく」「逃げられない」など陳腐な表現は絶対に使わない
- 意図が明確すぎるセリフ禁止：怪異の目的や感情が分かりやすいセリフは避ける（「釣れましたね」「一緒に〇〇しませんか」等）
- 怪異のセリフは以下のいずれかであるべき：
  - 文脈から浮いている（なぜそれを言うのか分からない）
  - 日常的すぎて逆に不気味（普通の挨拶、業務連絡のような口調）
  - 独り言のようで、語り手に向けていない
  - 意味不明だが妙に具体的（数字、曜日、人名など）
- 良い例：「火曜日だね」「三番目」「お母さんに怒られる」「もう届いたの」
- 悪い例：「逃げられないよ」「ずっと見てたよ」「連れていく」「やっと出られる」

irreversible_point:
{irreversible_point}`;

/**
 * Phase A用プロンプトを生成
 * @param diversityHint 多様性確保のためのヒント（オプション）
 * @param vocabCooldownHint 語彙クールダウンのヒント（オプション）
 * @param styleHint StyleBlueprintのスタイルヒント（オプション）
 */
export function buildPhaseAPrompt(
  normalRule: string,
  style: StoryStyle,
  word: string,
  detailBank: string[],
  diversityHint: string = '',
  vocabCooldownHint: string = '',
  styleHint: string = ''
): string {
  const styleGuide = getPhaseStyleGuide(style, 'A');
  const details = detailBank.length > 0
    ? `\n\n使用可能な日常ディテール: ${detailBank.slice(0, 3).join('、')}`
    : '';

  return `${PHASE_A_TEMPLATE.replace('{normal_rule}', normalRule)}
${details}
${styleGuide}
${diversityHint}${vocabCooldownHint}${styleHint}

キーワード反映ルール（必須）：
- キーワード「${word}」を本文中に1〜2回含めること（それ以上は連呼になるため禁止）
- 自然な形で登場させる（名詞として、または看板・張り紙・地名など）
- 不自然なタイトル回収は禁止

本文のみを出力。JSON形式は不要。`;
}

/**
 * Phase B用プロンプトを生成（続き書き専用）
 * @param keyword キーワード（主役化ルール用）
 * @param vocabCooldownHint 語彙クールダウンのヒント（オプション）
 */
export function buildPhaseBPrompt(
  anomaly: string,
  style: StoryStyle,
  previousText: string,
  keyword: string,
  vocabCooldownHint: string = ''
): string {
  const styleGuide = getPhaseStyleGuide(style, 'B');

  return `${PHASE_B_TEMPLATE.replace('{anomaly}', anomaly)}
${styleGuide}${vocabCooldownHint}

対象キーワード: 「${keyword}」
※ このキーワードを怪異の核/トリガーとして扱うこと

【Phase A 全文（これの直後から続けること）】:
---
${previousText}
---

【出力ルール】
- Phase A の末尾に自然に繋がる文から書き始める
- Phase A の冒頭を繰り返さない
- 導入・状況説明は書かない（既に Phase A で済んでいる）
- 時間進行や接続語で始める（「その日の〜」「しばらくして」「ふと」等）
- 本文のみを出力（JSON形式は不要）`;
}

/**
 * Phase C用プロンプトを生成
 * ending_mode対応:
 * - "open": 不可逆点で止める（デフォルト）
 * - "partial_explanation": 1点だけ明かして止める
 * @param keyword キーワード（主役化ルール用）
 * @param vocabCooldownHint 語彙クールダウンのヒント（オプション）
 */
export function buildPhaseCPrompt(
  irreversiblePoint: string,
  style: StoryStyle,
  previousText: string,
  endingMode: EndingMode = 'open',
  keyword: string = '',
  vocabCooldownHint: string = ''
): string {
  const styleGuide = getPhaseStyleGuide(style, 'C');
  const template = endingMode === 'partial_explanation'
    ? PHASE_C_TEMPLATE_PARTIAL
    : PHASE_C_TEMPLATE_OPEN;

  const keywordHint = keyword
    ? `\n対象キーワード: 「${keyword}」\n※ このキーワードを不可逆点/クライマックスで怪異の核として扱うこと`
    : '';

  return `${template.replace('{irreversible_point}', irreversiblePoint)}
${styleGuide}${vocabCooldownHint}
${keywordHint}

前段の文章（これに自然に続けて終わらせること）:
---
${previousText}
---

前段から自然に続く本文のみを出力。JSON形式は不要。文章はここで終了させる。`;
}

/**
 * スタイル別・フェーズ別のガイド
 *
 * Phase A は全スタイル共通で「1文のみ」（最大50字程度）
 * Phase B/C は Phase A が短くなった分、やや長めに調整
 */
function getPhaseStyleGuide(style: StoryStyle, phase: 'A' | 'B' | 'C'): string {
  const lengthGuides: Record<StoryStyle, Record<'A' | 'B' | 'C', string>> = {
    short: {
      A: '1文のみ（最大50字）。時間・場所・立場の事実だけ。',
      B: '約250字。違和感を端的に。',
      C: '約200字。不可逆点+短いクライマックス+余韻。',
    },
    medium: {
      A: '1文のみ（最大50字）。時間・場所・立場の事実だけ。',
      B: '約500字。違和感を丁寧に積み上げ。',
      C: '約450字。不可逆点+クライマックス（パニック/顕在化/脱出）+余韻。',
    },
    long: {
      A: '1文のみ（最大50字）。時間・場所・立場の事実だけ。',
      B: '約1000字。違和感を複数の描写で積み上げ。',
      C: '約800字。不可逆点+クライマックス（パニック/顕在化/脱出）+余韻。丁寧に。',
    },
  };

  return `\n文字数目安: ${lengthGuides[style][phase]}`;
}

// =============================================
// StyleBlueprint 注入（Phase B/C 専用）
// =============================================

import { StyleBlueprintData } from '@/types';

/**
 * StyleBlueprint をプロンプトに注入するためのテキストを生成
 * Phase B / C でのみ使用（Phase A には適用しない）
 *
 * @param style StyleBlueprintData または null
 * @returns プロンプトに追加する書き方指示テキスト
 */
export function buildStyleHint(style: StyleBlueprintData | null): string {
  if (!style) return '';

  const stanceLabels: Record<string, string> = {
    distant: '客観的・距離を置いた語り',
    involved: '当事者として巻き込まれた語り',
    detached: '淡々と事実を述べる語り',
  };

  const emotionLabels = [
    '感情を完全に抑制',
    '感情は最小限',
    '控えめに感情を出す',
  ];

  const sentenceLabels: Record<string, string> = {
    short: '短い文を連ねる',
    mixed: '長短を混ぜる',
    flowing: '流れるような長文',
  };

  const dialogueLabels: Record<string, string> = {
    rare: '会話は極力避ける',
    functional: '必要最低限の会話のみ',
    natural: '自然な会話を含める',
  };

  const stanceLabel = stanceLabels[style.narrator_stance] || style.narrator_stance;
  const emotionLabel = emotionLabels[style.emotion_level] || '感情を抑制';
  const sentenceLabel = sentenceLabels[style.sentence_style] || style.sentence_style;
  const dialogueLabel = dialogueLabels[style.dialogue_style] || style.dialogue_style;

  // 禁止事項を整形
  const prohibitions = style.style_prohibitions.length > 0
    ? style.style_prohibitions.join('、')
    : '特になし';

  // サンプルフレーズを整形
  const samplePhrases = style.sample_phrases.length > 0
    ? style.sample_phrases.map(p => `「${p}」`).join(' ')
    : '';

  return `
【書き方指示（流派: ${style.archetype_name}）】
視点: ${stanceLabel}
感情: ${emotionLabel}
文体: ${sentenceLabel}
会話: ${dialogueLabel}

文体の特徴:
${style.tone_features.map(f => `- ${f}`).join('\n')}

禁止: ${prohibitions}
${samplePhrases ? `\n参考フレーズ: ${samplePhrases}` : ''}
`;
}
